<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Player Search</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <main>
    <header class="top-bar">
      <h1>Search GRID Players</h1>
      <nav class="nav-links">
        <a href="index.html">Teams</a>
        <a href="player-search.html">Player Search</a>
        <a href="team-roster.html">Team Roster</a>
      </nav>
    </header>
    <p>This page mirrors the <code>getPlayer</code> query logic in <code>main.py</code>. Provide your API key and a nickname to request filtered player data (title ID fixed to VALORANT).</p>

    <form id="search-form" class="form-grid">
      <label>
        API Key
        <input id="apiKey" type="password" required autocomplete="off" placeholder="Enter x-api-key">
      </label>
      <label>
        Player nickname
        <input id="playerName" required placeholder="e.g. shroud">
      </label>
      <label>
        Operator
        <select id="operator">
          <option value="contains">contains</option>
          <option value="startsWith">startsWith</option>
          <option value="endsWith">endsWith</option>
          <option value="equalTo">equalTo</option>
          <option value="notEqualTo">notEqualTo</option>
        </select>
      </label>
      <label>
        Results limit
        <input id="limit" type="number" min="1" max="100" value="10">
      </label>
      <button type="submit">Search</button>
    </form>

    <div class="status" id="status">Awaiting search…</div>
    <div class="results" id="results"></div>
    <section>
      <h2>Player Detail</h2>
      <div class="status" id="detail-status">Select a player to view details.</div>
      <pre id="player-detail" style="background:#fff;padding:1rem;border-radius:8px;overflow:auto;max-height:320px;"></pre>
    </section>
  </main>

  <script>
    const API_URL = "https://api-op.grid.gg/central-data/graphql";
    const GAME_ID = "6";

    const form = document.getElementById("search-form");
    const statusEl = document.getElementById("status");
    const resultsEl = document.getElementById("results");
    const detailStatus = document.getElementById("detail-status");
    const detailOutput = document.getElementById("player-detail");
    let lastApiKey = "";

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const apiKey = document.getElementById("apiKey").value.trim();
      const playerName = document.getElementById("playerName").value.trim();
      const operator = document.getElementById("operator").value;
      const limit = Number(document.getElementById("limit").value) || 10;

      if (!apiKey) {
        statusEl.textContent = "API key is required.";
        return;
      }
      if (!playerName) {
        statusEl.textContent = "Enter a player nickname.";
        return;
      }

      statusEl.textContent = "Searching…";
      resultsEl.innerHTML = "";
      detailStatus.textContent = "Select a player to view details.";
      detailOutput.textContent = "";
      form.querySelector("button").disabled = true;
      lastApiKey = apiKey;

      const query = `
        query GetPlayers($playerFilter: PlayerFilter, $first: Int!) {
          players(filter: $playerFilter, first: $first) {
            edges {
              node {
                id
                nickname
                title {
                  name
                }
                team {
                  name
                }
              }
            }
          }
        }
      `;

      const variables = {
        playerFilter: {
          titleId: GAME_ID,
          nickname: { [operator]: playerName }
        },
        first: limit
      };

      try {
        const response = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-api-key": apiKey
          },
          body: JSON.stringify({ query, variables })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const payload = await response.json();
        if (payload.errors) {
          throw new Error(payload.errors.map((err) => err.message).join("; "));
        }

        const players = payload?.data?.players?.edges ?? [];
        if (!players.length) {
          statusEl.textContent = "No players match that query.";
          return;
        }

        statusEl.textContent = `Showing ${players.length} result(s).`;
        players.forEach(({ node }) => {
          const card = document.createElement("article");
          card.className = "card";

          const heading = document.createElement("h2");
          heading.textContent = node.nickname ?? "Unknown";
          card.appendChild(heading);

          const idLine = document.createElement("span");
          idLine.textContent = `ID: ${node.id ?? "?"}`;
          card.appendChild(idLine);

          const titleLine = document.createElement("span");
          titleLine.textContent = `Title: ${node.title?.name ?? "N/A"}`;
          card.appendChild(titleLine);

          const teamLine = document.createElement("span");
          teamLine.textContent = `Team: ${node.team?.name ?? "No team"}`;
          card.appendChild(teamLine);

          const infoLink = document.createElement("button");
          infoLink.type = "button";
          infoLink.textContent = "View full profile";
          infoLink.addEventListener("click", () => loadPlayerDetail(node.id));
          card.appendChild(infoLink);

          resultsEl.appendChild(card);
        });
      } catch (error) {
        statusEl.textContent = `Search failed: ${error.message}`;
      } finally {
        form.querySelector("button").disabled = false;
      }
    });

    const PLAYER_INFO_QUERY = `
      query PlayerInfo($playerId: ID!) {
          player(id: $playerId) {
            id
            nickname
            roles {
              id
              name
              title {
                name
              }
            }
          }
        }
    `;

    async function loadPlayerDetail(playerId) {
      if (!lastApiKey) {
        detailStatus.textContent = "Run a search and provide an API key first.";
        return;
      }
      detailStatus.textContent = "Fetching player profile…";
      detailOutput.textContent = "";
      try {
        const response = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-api-key": lastApiKey
          },
          body: JSON.stringify({ query: PLAYER_INFO_QUERY, variables: { playerId } })
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const payload = await response.json();
        if (payload.errors) {
          throw new Error(payload.errors.map((err) => err.message).join("; "));
        }
        const player = payload?.data?.player;
        if (!player) {
          detailStatus.textContent = "Player not found.";
          return;
        }
        detailStatus.textContent = `Profile loaded for ${player.nickname ?? player.fullName ?? player.id}.`;
        detailOutput.textContent = JSON.stringify(player, null, 2);
      } catch (error) {
        detailStatus.textContent = `Failed to load details: ${error.message}`;
      }
    }
  </script>
</body>
</html>
